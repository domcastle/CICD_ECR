<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Justic - Library</title>
<link rel="stylesheet" href="css/style.css">

<script>
  const token = localStorage.getItem("access_token");
  if (!token) location.href = "index.html";
</script>

<style>
.video-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* ğŸ”¥ ì¸ë„¤ì¼ ë¸”ëŸ¬ ë°°ê²½ */
.image-bg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(28px);
  transform: scale(1.15);
  opacity: 0.45;
  z-index: 0;
  pointer-events: none;
}

/* ğŸ”¥ ì˜ìƒ ë¸”ëŸ¬ ë°°ê²½ */
.video-bg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(28px);
  transform: scale(1.15);
  opacity: 0.45;
  z-index: 0;
  pointer-events: none;
  display: none;
}

.video-modal-center {
  width: 100%;
  display: flex;
  justify-content: center;
  position: relative;
  z-index: 1;
}

.video-modal-content { display: flex; gap: 36px; }
.short-card { display: flex; flex-direction: column; align-items: center; gap: 14px; }
.short-title {
  font-family: "Paperlogy", sans-serif;
  font-weight: 600;
  color: #fff;
  opacity: 0.95;
  text-align: center;
  font-size: clamp(18px, 1.8vw, 24px);
  letter-spacing: 0.04em;
}

.short-video { width: 300px; aspect-ratio: 9/16; background:black; border-radius:14px; overflow:hidden; }
.short-video video { width:100%; height:100%; object-fit:cover; }

.youtube-btn {
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  background:#fff;
  border:1px solid #dadce0;
  border-radius:6px;
  padding:10px 16px;
  cursor:pointer;
}
.youtube-btn:hover { background:#f7f8f8; }
.youtube-icon { width:20px; height:20px; }

/* ===============================
   ì œëª© ì…ë ¥ ëª¨ë‹¬
================================ */
.title-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.title-box {
  background: #fff;
  padding: 24px;
  border-radius: 14px;
  width: 320px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.title-box h3 {
  margin: 0;
  font-size: 18px;
}

.title-box input {
  padding: 10px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.title-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.title-actions button {
  padding: 8px 14px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

#confirmBtn {
  background: #000;
  color: #fff;
}

@media(max-width:900px){
  .video-modal-content{ flex-direction:column; align-items:center; }
}

/* ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ ì¹´ë“œ ë‚´ë¶€ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
.video-label {
  color: rgba(255, 255, 255, 0.8);
  font-size: 12px;
  margin-top: 8px;
  background: rgba(0,0,0,0.3);
  padding: 2px 8px;
  border-radius: 4px;
}

/* âœ… ì¶”ê°€: ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œì—ì„œ "í¸ì§‘ ì¤‘" ë¡œë”© ì˜¤ë²„ë ˆì´ìš© ìŠ¤í”¼ë„ˆ */
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<div class="top-menu">
  <div class="menu-btn" id="menuBtn"><span></span></div>
  <div class="menu-dropdown" id="menuDropdown">
    <a href="#" id="goMainBtn">ì˜ìƒ ìƒì„±í•˜ëŸ¬ ê°€ê¸°</a>
    <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

<div class="library-container">
  <div class="library-header">
    <img src="/images/library.png" alt="ë¼ì´ë¸ŒëŸ¬ë¦¬" class="library-image" />
  </div>
  <div class="video-grid" id="videoGrid"></div>
</div>

<script>
const videoGrid = document.getElementById("videoGrid");
const menuBtn = document.getElementById("menuBtn");
const menuDropdown = document.getElementById("menuDropdown");
const logoutBtn = document.getElementById("logoutBtn");
const goMainBtn = document.getElementById("goMainBtn");

/* ë©”ë‰´ ë¡œì§ */
menuBtn.onclick = () => menuDropdown.classList.toggle("show");
logoutBtn.onclick = () => { localStorage.removeItem("access_token"); location.href="index.html"; };
goMainBtn.onclick = () => location.href="main.html";
document.addEventListener("click", e => {
  if(!menuBtn.contains(e.target) && !menuDropdown.contains(e.target))
    menuDropdown.classList.remove("show");
});

/* ì¸ë„¤ì¼ ë¡œë“œ (ë°±ì—”ë“œ ê²½ë¡œ /thumbnail/${taskId} ì‚¬ìš©) */
async function loadThumb(img, taskId){
  try{
    const res = await fetch(`/api/video/thumbnail/${taskId}`, {
      headers:{Authorization:`Bearer ${token}`}
    });
    if(!res.ok) throw new Error();
    img.src = URL.createObjectURL(await res.blob());
  }catch{
    img.src = "";
  }
}

/* ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (ëª¨ë“  íŒŒì¼ ê°œë³„ ë…¸ì¶œ) */
async function loadLibrary(){
  const res = await fetch("/api/video/list",{ headers:{Authorization:`Bearer ${token}`}});
  const data = await res.json();

  if(!data.videos || !data.videos.length){
    videoGrid.innerHTML = `
      <div class="empty-library">
        <div class="empty-main">ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
        <div class="empty-sub" id="goCreate">ì˜ìƒ ìƒì„±í•˜ëŸ¬ ê°€ê¸°</div>
      </div>
    `;
    document.getElementById("goCreate").onclick = () => location.href="main.html";
    return;
  }

  data.videos.forEach(fullId => {
    const card = document.createElement("div");
    card.className = "video-card";

    // âœ… íŒŒì¼ëª…ì—ì„œ ë² ì´ìŠ¤ ID ì¶”ì¶œ (ì¸ë„¤ì¼ ë§¤ì¹­ìš©)
    const baseId = fullId.split('_v')[0].replace('_processed', '');
    
    const img = document.createElement("img");
    loadThumb(img, baseId);

    // âœ… ì¹´ë“œ í•˜ë‹¨ì— ë²„ì „ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
    const label = document.createElement("div");
    label.className = "video-label";
    label.innerText = fullId.includes('_v') ? fullId.split('_').pop().toUpperCase() : "ORIGINAL";

    card.appendChild(img);
    card.appendChild(label);
    
    // í´ë¦­ ì‹œ í•´ë‹¹ ì˜ìƒì˜ ë² ì´ìŠ¤ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ 3ë¶„í•  ë¯¸ë¦¬ë³´ê¸° ì—´ê¸°
    card.onclick = () => openPreview(baseId); 
    videoGrid.appendChild(card);
  });
}

/* ì˜ìƒ fetch (variant íŒŒë¼ë¯¸í„° ì‚¬ìš©) */
async function fetchVideo(taskId, variant){
  const url = variant ? `/api/video/stream/${taskId}?variant=${variant}` : `/api/video/stream/${taskId}`;
  const res = await fetch(url, {
    headers:{Authorization:`Bearer ${token}`}
  });
  if(!res.ok) throw new Error();
  return URL.createObjectURL(await res.blob());
}

/* ìœ íŠœë¸Œ ì—…ë¡œë“œ ëª¨ë‹¬ */
function openTitleModal(taskId, variant){
  const modal = document.createElement("div");
  modal.className = "title-modal";
  modal.innerHTML = `
    <div class="title-box">
      <h3>YouTube ì˜ìƒ ì—…ë¡œë“œ</h3>
      <input type="text" id="youtubeTitle" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
      <div class="title-actions">
        <button id="cancelBtn">ì·¨ì†Œ</button>
        <button id="confirmBtn">ì—…ë¡œë“œ</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  modal.querySelector("#cancelBtn").onclick = () => modal.remove();

  modal.querySelector("#confirmBtn").onclick = async () => {
    const title = modal.querySelector("#youtubeTitle").value.trim();
    if(!title) { alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    try{
      const res = await fetch("/api/video/youtube/upload", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body: JSON.stringify({
          video_key: taskId,
          variant: variant || "v1", // ì—…ë¡œë“œ ì‹œë„í•  ë²„ì „
          title: title
        })
      });
      if(!res.ok) throw new Error();
      alert("YouTube ì—…ë¡œë“œ ì™„ë£Œ!");
      modal.remove();
    }catch{
      alert("ì—…ë¡œë“œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  };
}

/* âœ… ìˆ˜ì •: ì‡¼ì¸  ì¹´ë“œ ìƒì„±
   - (ì—†ìŒ) ëŒ€ì‹  ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
   - v1/v2ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì„œ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ ì˜ìƒ í‘œì‹œ
   - ìƒì„± ì¤‘ì—ëŠ” ì—…ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
*/
async function createShort(title, taskId, variant){
  const wrap = document.createElement("div");
  wrap.className = "short-card";
  wrap.innerHTML = `
    <div class="short-title">${title}</div>
    <div class="short-video" style="position:relative;">
      <video controls></video>
    </div>
    <button class="youtube-btn">
      <img class="youtube-icon" src="https://upload.wikimedia.org/wikipedia/commons/f/fd/YouTube_full-color_icon_%282024%29.svg">
      <span class="youtube-text">ì—…ë¡œë“œ</span>
    </button>
  `;

  const video = wrap.querySelector("video");
  const box = wrap.querySelector(".short-video");
  const btn = wrap.querySelector(".youtube-btn");

  // ë¡œë”© ì˜¤ë²„ë ˆì´
  const overlay = document.createElement("div");
  overlay.style.position = "absolute";
  overlay.style.inset = "0";
  overlay.style.display = "none";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.flexDirection = "column";
  overlay.style.gap = "10px";
  overlay.style.background = "rgba(0,0,0,0.55)";
  overlay.style.color = "#fff";
  overlay.style.textAlign = "center";
  overlay.style.padding = "16px";
  overlay.style.backdropFilter = "blur(3px)";
  overlay.style.zIndex = "2";

  const spinner = document.createElement("div");
  spinner.style.width = "34px";
  spinner.style.height = "34px";
  spinner.style.border = "3px solid rgba(255,255,255,0.35)";
  spinner.style.borderTopColor = "#fff";
  spinner.style.borderRadius = "50%";
  spinner.style.animation = "spin 1s linear infinite";

  const overlayMain = document.createElement("div");
  overlayMain.textContent = "ì˜ìƒì´ í¸ì§‘ë˜ê³  ìˆìŠµë‹ˆë‹¤";
  overlayMain.style.fontWeight = "700";
  overlayMain.style.fontSize = "14px";

  const overlaySub = document.createElement("div");
  overlaySub.textContent = "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.";
  overlaySub.style.fontSize = "12px";
  overlaySub.style.opacity = "0.9";
  overlaySub.style.lineHeight = "1.4";

  overlay.append(spinner, overlayMain, overlaySub);
  box.appendChild(overlay);

  function setLoading(isLoading){
    if (isLoading) {
      overlay.style.display = "flex";
      btn.style.opacity = "0.45";
      btn.style.pointerEvents = "none";
      btn.title = "ì˜ìƒ ìƒì„± ì¤‘ì—ëŠ” ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    } else {
      overlay.style.display = "none";
      btn.style.opacity = "1";
      btn.style.pointerEvents = "auto";
      btn.title = "";
    }
  }

  async function tryLoadVideo(){
    try {
      video.src = await fetchVideo(taskId, variant);
      setLoading(false);
      return true;
    } catch {
      setLoading(true);
      return false;
    }
  }

  // ìµœì´ˆ ì‹œë„
  const ok = await tryLoadVideo();

  // v1/v2ëŠ” ìƒì„± ì§€ì—°ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ìë™ ì¬ì‹œë„
  // - original("")ì€ ë³´í†µ ë°”ë¡œ ìˆì–´ ì¬ì‹œë„ ë¶ˆí•„ìš”
  let retryTimer = null;
  const shouldRetry = (variant === "v1" || variant === "v2");
  if (!ok && shouldRetry) {
    retryTimer = setInterval(async () => {
      if (!document.body.contains(wrap)) {
        clearInterval(retryTimer);
        return;
      }
      if (video.src) {
        clearInterval(retryTimer);
        return;
      }
      const success = await tryLoadVideo();
      if (success) clearInterval(retryTimer);
    }, 8000);
  }

  btn.onclick = () => openTitleModal(taskId, variant);
  wrap._videoEl = video;
  wrap._variant = variant;
  return wrap;
}

/* ğŸ”¥ ë¯¸ë¦¬ë³´ê¸° (ê¸°ì¡´ 3ë¶„í•  ë¹„êµ êµ¬ì¡° ìœ ì§€) */
async function openPreview(taskId){
  const modal = document.createElement("div");
  modal.className = "video-modal";

  const imgBg = document.createElement("img");
  imgBg.className = "image-bg";
  loadThumb(imgBg, taskId);

  const videoBg = document.createElement("video");
  videoBg.className = "video-bg";
  videoBg.muted = true; videoBg.loop = true; videoBg.playsInline = true;

  const center = document.createElement("div");
  center.className = "video-modal-center";
  const content = document.createElement("div");
  content.className = "video-modal-content";

  // ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ 3ê°€ì§€ ë²„ì „ì„ ë‚˜ë€íˆ ìƒì„±
  const originalCard  = await createShort("Original", taskId, "");
  const processedCard = await createShort("Edited v1", taskId, "v1");
  const processedV2   = await createShort("Edited v2", taskId, "v2");

  [originalCard, processedCard, processedV2].forEach(card => {
    const v = card._videoEl;
    const vr = card._variant;

    v.addEventListener("play", async () => {
      videoBg.src = await fetchVideo(taskId, vr);
      videoBg.currentTime = v.currentTime;
      imgBg.style.display = "none";
      videoBg.style.display = "block";
      videoBg.play();
    });

    v.addEventListener("pause", () => videoBg.pause());
    v.addEventListener("seeking", () => videoBg.currentTime = v.currentTime);
  });

  content.append(originalCard, processedCard, processedV2);
  center.appendChild(content);
  modal.append(imgBg, videoBg, center);
  document.body.appendChild(modal);

  modal.onclick = () => modal.remove();
  content.onclick = e => e.stopPropagation();
}

loadLibrary();
</script>
</body>
</html>
